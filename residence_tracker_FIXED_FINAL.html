<!DOCTYPE html>
<!-- Version: 2026-01-30-FINAL-v3 -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Calendar 2026 v2.1</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAIAAOAQAAFgAAAIlQTkcNChoKAAAADUlIRFIAAAAQAAAAEAgCAAAAkJFoNgAAANVJREFUeJyNkjEKAjEQRf/E2S3WYm3EwguId7AXPIG1tYqVeA0PYWFl4wm8iI2CoMWCNusmYxFEY5LFIU1++Pz3h9C23cXXCIG1FE1eTHuFeoz7o81wJcBxvrzt9tzKGQRn6H0iw1I5dyGIxo/oGNLc+EhpZmIhPFhfHAOQEK46SU4G9wCblwAkhLQyOP/Zwdao6RBgrd2Sir5EEyQkB0VrIPaIqIYIXBYOlS1dahUL4cOs4xjsX8r4OVFoBNi8BILRUlYKEt6V14FABL/YxxBglbotvQDpiEqFWhWREwAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAIAAACyr5FlAAACvUlEQVR4nO3csYpkRRSA4VPNnWB2MVMMTAzU1/AtzMTEaMHXMTX3LXwAwVQ2MzMwGhFkpvsazA7MjPxZQ8/q99FxURQ/597q4K4fP/pk/vf2Ndtxv3m1vfnu879ebeu47+s8Kx/WOt3+/dmHn779+ofzrPhgP53W4fDnz7/8+tU3h9ev53Q67/ozczj7ivxniIMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgbXOmT/W+39bDj0e2/e7SW3gB9jX7cRzFM9vVB+f/ZvZ7Z1+znfar65Ph8dj25fe/X3oPl7fPXM38cdyufvtijp4v75gcM/dxrLm6Mzme8M4xM7Pfv3Y4iqfcVh64rfyL/zlI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJg7TNfuktvByO4qltbZfewsuw1qxL7+Gl2W5vPFnejYzb48HweGz76c3Hl97D5e1rttN+c73dfrvmeuY4xsiYHPf2Nftxv70zOZ7wzjEzM2vWGkfxjNvKg91t5TnPFJI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDtI/9X9SFcQASJcAAAAASUVORK5CYII=">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAIAAADdvvtQAAAC8klEQVR4nO3dsYokRRzA4aq93sDlzE4MzIS71/A1TAwEowNfx9AH8C1MBR/gUjOTS1ZE2Jkpg+Wim90RfrvMqN/HxN1F8ePfXZP0/OmzLwYfWXNs+3V7s739/vWfN9vcrzWf8vpXcx7u/nrz6st33/z4lNf9YO0P88XVH7/8+u7rb1+8fLkOh+e4yxjj6pmuy/+EgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiCSbTzpN0T+O+aHH4/a1u7cS7hIa461HzbnpO360+f6ENC/2v3nnq5vDobQ47avfvj93Gu4RGuM6zne77bttzdj71n2IBPouPuArncm0AnegY5b969BNucUp7SHOYX9A/4HIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIi2cY69xIumc05ZZvbuZdwqeYc89xruHzb3a2n2BFrjDHH3e7KEHrc9vPbz8+9hku05tj26/Zm2303xydj7IdxdJQJdNyaY+3X3d4EOsE70APmmHPYnJOcwh62nMJO8/wiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASARE8jf8k1MvHvNjiQAAAABJRU5ErkJggg==">
    <link rel="icon" type="image/png" sizes="512x512" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAIAAAB7GkOtAAAHVElEQVR4nO3XMRHCABREQWCwQBUJIAAHOMAFEmIoDqKCAg3oABm/eLsKrntzx+2yHKDquV6nJ0z6vfbpCZPet/v0hGGn6QEAzBAAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiDo/tu/0BpjzuU4vgDEeAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBA1Hl/LtMbYM46PQDmeAAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUX9EYA2vfA6lCgAAAABJRU5ErkJggg==">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Travel Calendar">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4em;
            margin-bottom: 0;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 0.85em;
        }

        .sync-manual-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .sync-manual-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: rotate(180deg);
        }

        .sync-timestamp {
            text-align: center;
            font-size: 0.7em;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-indicator.syncing {
            background: #FFC107;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .sync-indicator.error {
            background: #f44336;
            animation: none;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .login-box p {
            margin-bottom: 30px;
            color: #666;
            line-height: 1.6;
        }

        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s;
        }

        .google-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .google-btn:hover:not(:disabled) {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .profile-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .profile-btn {
            padding: 10px 25px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .profile-btn.active {
            background: white;
            color: #667eea;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 15px;
        }

        .calendar-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .year-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .year-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 44px;
            min-height: 44px;
        }

        .year-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .year-display {
            font-size: 1.6em;
            font-weight: bold;
            color: #333;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            padding: 15px 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-size: 0.9em;
            min-height: 44px;
        }

        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .legend-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .legend-circle {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            margin: 0 auto 3px;
        }

        .calendar-month {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .month-header {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 8px 2px;
            font-size: 0.75em;
        }

        .day-cell {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            padding: 4px 2px;
            min-height: 65px;
        }

        .day-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .day-cell:hover .edit-icon {
            opacity: 1;
        }

        .day-number {
            font-weight: 600;
            font-size: 0.9em;
            color: #333;
            margin-bottom: 2px;
        }

        .day-note {
            font-size: 0.55em;
            color: #333;
            text-align: center;
            line-height: 1.1;
            max-height: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 700;
            margin-top: auto;
            padding-top: 1px;
            word-break: break-word;
        }

        .holiday-note {
            font-size: 0.52em;
            color: #c62828;
            text-align: center;
            line-height: 1.2;
            font-weight: 700;
            margin-top: 2px;
            padding: 3px 2px;
            border-radius: 3px;
            height: 18px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .edit-icon {
            position: absolute;
            top: 1px;
            right: 1px;
            font-size: 0.7em;
            opacity: 0.4;
            transition: opacity 0.2s;
            cursor: pointer;
            z-index: 5;
        }

        .edit-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .day-cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .day-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .summary-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .summary-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .monthly-bars {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .month-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .month-label {
            font-weight: 600;
            font-size: 0.9em;
            width: 40px;
            text-align: right;
            color: #555;
        }

        .month-bar-container {
            flex: 1;
            height: 28px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            position: relative;
        }

        .month-bar-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .month-bar-segment:hover {
            filter: brightness(1.1);
            cursor: pointer;
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .summary-location {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-days {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }

        .summary-label {
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        .monthly-breakdown {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .breakdown-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            table-layout: fixed;
        }

        .breakdown-table th {
            background: #f8f9fa;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            width: 14.28%;
        }

        .breakdown-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .breakdown-table tr:hover {
            background: #f8f9fa;
        }

        .total-spain {
            background: #fff3cd;
            font-weight: 600;
        }

        .floating-counter {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 15px 20px;
            border-radius: 50%;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            min-width: 75px;
            min-height: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .floating-counter:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .floating-label {
            font-size: 0.75em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .floating-number {
            font-size: 2em;
            font-weight: bold;
            line-height: 1;
        }

        @media (max-width: 768px) {
            .floating-counter {
                bottom: 20px;
                right: 20px;
                padding: 15px 20px;
                min-width: 80px;
                min-height: 80px;
            }
            
            .floating-number {
                font-size: 2em;
            }

            body {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .profile-btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            .dashboard {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 20px;
            }

            .calendar-section, .summary-section {
                padding: 15px;
            }

            .legend {
                gap: 8px;
            }

            .legend-item {
                padding: 6px 12px;
                font-size: 0.9em;
            }

            .year-selector {
                margin-bottom: 15px;
            }

            .year-display {
                font-size: 1.5em;
            }

            .calendar-month {
                padding: 15px;
            }

            .month-header {
                font-size: 1.1em;
            }

            .day-cell {
                min-height: 50px;
                padding: 3px;
            }

            .day-number {
                font-size: 0.85em;
            }

            .day-note, .holiday-note {
                font-size: 0.55em;
                max-height: 18px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-days {
                font-size: 1.8em;
            }

            .breakdown-table {
                font-size: 0.7em;
            }

            .breakdown-table th,
            .breakdown-table td {
                padding: 6px 2px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .action-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
        }

        /* Tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            body {
                padding: 15px;
            }

            .dashboard {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .header h1 {
                font-size: 1.6em;
            }

            .year-display {
                font-size: 1.8em;
            }

            .day-cell {
                min-height: 65px;
            }
        }

        /* Desktop */
        @media (min-width: 1025px) {
            body {
                padding: 20px;
            }

            .container {
                border-radius: 20px;
            }

            .dashboard {
                grid-template-columns: 1fr 500px;
                gap: 30px;
                padding: 30px;
            }

            .header {
                padding: 30px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .profile-btn {
                padding: 12px 30px;
                font-size: 1.1em;
            }

            .calendar-section, .summary-section {
                padding: 25px;
            }

            .year-display {
                font-size: 2em;
            }

            .legend {
                gap: 15px;
                /* Mantener flex para sticky */
            }

            .legend-item {
                padding: 10px 15px;
                font-size: 1em;
            }

            .calendar-grid {
                gap: 8px;
            }

            .day-cell {
                min-height: 70px;
                padding: 5px;
                border-radius: 8px;
            }

            .day-number {
                font-size: 1em;
            }

            .day-note {
                font-size: 0.65em;
                max-height: 24px;
            }

            .holiday-note {
                font-size: 0.55em;
                height: 18px;
            }

            .edit-icon {
                font-size: 0.75em;
            }

            .calendar-month {
                padding: 20px;
                border-radius: 12px;
            }

            .month-header {
                font-size: 1.3em;
            }

            .summary-card {
                padding: 20px;
            }

            .summary-days {
                font-size: 2em;
            }

            .breakdown-table {
                font-size: 0.82em;
                min-width: auto;
            }

            .breakdown-table th,
            .breakdown-table td {
                padding: 8px 4px;
                white-space: nowrap;
            }

            .monthly-breakdown {
                overflow-x: visible;
                padding: 15px;
            }

            .floating-counter {
                bottom: 30px;
                right: 30px;
                min-width: 100px;
                min-height: 100px;
                padding: 20px 30px;
            }

            .floating-number {
                font-size: 2.5em;
            }

            .floating-label {
                font-size: 0.9em;
            }
        }

        /* Extra small phones */
        @media (max-width: 402px) {
            body {
                padding: 2px;
            }
            
            .container {
                border-radius: 6px;
            }
            
            .header {
                padding: 10px 6px;
            }
            
            .header h1 {
                font-size: 1em;
            }

            .profile-btn {
                padding: 4px 8px;
                font-size: 0.75em;
            }
            
            .sync-status {
                font-size: 0.7em;
                padding: 5px;
                margin-top: 8px;
            }

            .legend {
                padding: 6px 3px;
                gap: 4px;
            }

            .legend-item {
                padding: 3px 6px;
                font-size: 0.7em;
            }

            .day-cell {
                min-height: 50px;
                padding: 2px 0.5px;
            }

            .calendar-grid {
                gap: 1px;
            }
            
            .calendar-month {
                padding: 5px;
                margin-bottom: 5px;
            }
            
            .month-header {
                font-size: 0.9em;
                margin-bottom: 5px;
            }
            
            .day-header {
                font-size: 0.65em;
            }

            .floating-counter {
                min-width: 55px;
                min-height: 55px;
                padding: 6px 8px;
                bottom: 6px;
                right: 6px;
            }

            .floating-number {
                font-size: 1.4em;
            }

            .floating-label {
                font-size: 0.55em;
            }

            .day-number {
                font-size: 0.65em;
            }

            .day-note {
                font-size: 0.42em;
                line-height: 1.2;
                max-height: 14px;
            }
            
            .holiday-note {
                height: 16px;
                padding: 2px 1px;
                font-size: 0.4em;
                line-height: 1.2;
            }
            
            .edit-icon {
                font-size: 0.65em;
            }

            .breakdown-table th,
            .breakdown-table td {
                padding: 4px 2px;
                font-size: 0.75em;
            }
            
            .breakdown-table th small {
                font-size: 0.6em;
            }
            
            .summary-section {
                padding: 10px;
            }
        }

        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 100000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
        }
        
        .modal-input[contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }
        
        .modal-input[contenteditable]:focus {
            border-color: #667eea;
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #5568d3;
        }

        .modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background: #d0d0d0;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            background: #667eea;
            color: white;
        }

        .action-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .color-MAD { background-color: #FFEB3B; }
        .color-AND { background-color: #2196F3; }
        .color-IT { background-color: #F44336; }
        .color-FR { background-color: #4CAF50; }
        .color-OTHER { background-color: rgb(223, 179, 245); }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>üîê Iniciar Sesi√≥n</h2>
            <p>Para sincronizar tus datos y eventos del calendario, necesitas conectar tu cuenta de Google.</p>
            <button class="google-btn" id="googleSignInBtn" onclick="signIn()" disabled>
                <svg width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                </svg>
                <span id="btnText">Cargando...</span>
            </button>
        </div>
    </div>

    <div class="container hidden" id="mainApp">
        <div class="header">
            <h1>Travel Calendar</h1>
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">Sincronizado</span>
                <button class="sync-manual-btn" onclick="manualSync()" title="Sincronizar ahora">üîÑ</button>
            </div>
            <div class="sync-timestamp" id="syncTimestamp"></div>
            <div class="profile-selector">
                <button class="profile-btn active" onclick="switchProfile('Ricardo')">Ricardo</button>
                <button class="profile-btn" onclick="switchProfile('Sylvia')">Sylvia</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="calendar-section">
                <div class="year-selector">
                    <button class="year-btn" onclick="changeYear(-1)">‚Äπ</button>
                    <div class="year-display" id="yearDisplay">2026</div>
                    <button class="year-btn" onclick="changeYear(1)">‚Ä∫</button>
                </div>

                <div class="legend">
                    <div class="legend-item selected" onclick="selectLocation('MAD')" data-location="MAD">
                        <div class="legend-circle" style="background: #FFEB3B;"></div>
                        <span>Madrid</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('AND')" data-location="AND">
                        <div class="legend-circle" style="background: #2196F3;"></div>
                        <span>Andratx</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('IT')" data-location="IT">
                        <div class="legend-circle" style="background: #F44336;"></div>
                        <span>Italia</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('FR')" data-location="FR">
                        <div class="legend-circle" style="background: #4CAF50;"></div>
                        <span>Francia</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('OTHER')" data-location="OTHER">
                        <div class="legend-circle" style="background: rgb(223, 179, 245);"></div>
                        <span>Other</span>
                    </div>
                </div>

                <div id="calendar"></div>
            </div>

            <div class="summary-section">
                <div class="summary-title">üìä Distribuci√≥n Mensual</div>
                <div id="monthlyBars" class="monthly-bars"></div>
                <div class="monthly-breakdown">
                    <div class="breakdown-title">üìÖ Resumen Mensual</div>
                    <div id="monthlyTable"></div>
                </div>
                <div class="actions">
                    <button class="action-btn" onclick="exportData()">üíæ Exportar</button>
                    <button class="action-btn" onclick="importData()">üì• Importar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-counter" id="floatingCounter" onclick="scrollToTable()" style="cursor: pointer;">
        <div class="floating-label">üá™üá∏ Espa√±a</div>
        <div class="floating-number" id="floatingNumber">0</div>
    </div>

    <!-- Overlay de fondo -->
    
    <!-- Modal centrado -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Editar D√≠a</div>
            <div class="modal-label">Nota / Evento:</div>
            <div class="format-buttons" style="margin-bottom: 8px; display: flex; gap: 8px;">
                <button type="button" class="format-btn" onclick="applyFormat('black')" style="background: #000; color: #fff; padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">‚¨õ Negro</button>
                <button type="button" class="format-btn" onclick="applyFormat('red')" style="background: rgb(224, 22, 39); color: #fff; padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">üü• Rojo</button>
            </div>
            <div class="modal-input" id="noteInput" contenteditable="true" style="min-height: 80px; max-height: 200px; overflow-y: auto; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1em; line-height: 1.4; outline: none;" data-placeholder="Ej: Reuni√≥n con cliente, Vuelo a Madrid..."></div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn secondary" onclick="closeModal()">Cancelar</button>
                <button type="button" class="modal-btn primary" onclick="saveNote()">Guardar</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(event)">

    <script>
        // Manejador de errores global
        window.onerror = function(msg, url, linenumber) {
            console.error('Error:', msg, 'L√≠nea:', linenumber);
            return true;
        };

        const LOCATIONS = {
            MAD: { name: 'Madrid', color: '#FFEB3B', emoji: 'üü°' },
            AND: { name: 'Andratx', color: '#2196F3', emoji: 'üîµ' },
            IT: { name: 'Italia', color: '#F44336', emoji: 'üî¥' },
            FR: { name: 'Francia', color: '#4CAF50', emoji: 'üü¢' },
            OTHER: { name: 'Other', color: 'rgb(223, 179, 245)', emoji: 'üü£' }
        };

        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        const DAYS = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

        // IMPORTANTE: Client ID configurado
        const CLIENT_ID = '62569860135-87ahagt2aflno2e0o022l44iovnk2de4.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1ED2d1fsBUumzodJV036hvd0h1yfgVNb9bF-WYTqC3qk';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar.readonly';
        
        // Palabras clave para buscar en Calendar
        const CALENDAR_KEYWORDS = [
            'Lunes Tools', 'Lunes Miogest', 'Lunes Gestim', 'Lunes Inmovilla',
            'Lunes Regold', 'Lunes HCPro', 'Trimestral', 'Offsite',
            'Taskforce Regold', 'DNs', 'Estrategia CRM\'s',
            'Consejo', 'Real Estate Awards'
        ];

        let currentYear = 2026;
        let currentProfile = 'Ricardo';
        let selectedLocation = 'MAD';
        let currentEditDay = null;
        let tokenClient;
        let accessToken = null;
        let lastCalendarSync = null;
        let lastServerTimestamp = 0;
        let dataLoaded = false; // BLOQUEO: No permitir ediciones hasta cargar datos
        let saveTimer = null; // Timer para debounce
        let pendingChanges = false; // Flag de cambios sin guardar

        let data = {
            Ricardo: {},
            Sylvia: {}
        };

        // Inicializar Google Auth (se llama cuando se carga el script de Google)
        window.initGoogleAuth = function() {
            if (typeof google === 'undefined' || !google.accounts) {
                setTimeout(window.initGoogleAuth, 500);
                return;
            }
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse,
            });
            
            const btn = document.getElementById('googleSignInBtn');
            const btnText = document.getElementById('btnText');
            if (btn && btnText) {
                btn.disabled = false;
                btnText.textContent = 'Conectar con Google';
            }
        };

        // Calcular festivos
        function getEasterDate(year) {
            const f = Math.floor,
                G = year % 19,
                C = f(year / 100),
                H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
                I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
                J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
                L = I - J,
                month = 3 + f((L + 40) / 44),
                day = L + 28 - 31 * f(month / 4);
            return new Date(year, month - 1, day);
        }

        function getSpainHolidays(year) {
            const easter = getEasterDate(year);
            const holidays = {};
            
            // Festivos fijos Espa√±a
            holidays[`${year}-01-01`] = 'A√±o Nuevo';
            holidays[`${year}-01-06`] = 'Epifan√≠a del Se√±or';
            holidays[`${year}-05-01`] = 'Fiesta del Trabajo';
            holidays[`${year}-08-15`] = 'Asunci√≥n de la Virgen';
            holidays[`${year}-10-12`] = 'Fiesta Nacional de Espa√±a';
            holidays[`${year}-11-01`] = 'Todos los Santos';
            holidays[`${year}-12-06`] = 'D√≠a de la Constituci√≥n';
            holidays[`${year}-12-08`] = 'Inmaculada Concepci√≥n';
            holidays[`${year}-12-25`] = 'Navidad';
            
            // Festivos Comunidad de Madrid
            holidays[`${year}-05-02`] = 'Fiesta de la Comunidad de Madrid';
            holidays[`${year}-07-25`] = 'Santiago Ap√≥stol';
            
            // Festivos m√≥viles (basados en Semana Santa)
            const juevesSanto = new Date(easter);
            juevesSanto.setDate(easter.getDate() - 3);
            holidays[`${year}-${String(juevesSanto.getMonth() + 1).padStart(2, '0')}-${String(juevesSanto.getDate()).padStart(2, '0')}`] = 'Jueves Santo';
            
            const viernesSanto = new Date(easter);
            viernesSanto.setDate(easter.getDate() - 2);
            holidays[`${year}-${String(viernesSanto.getMonth() + 1).padStart(2, '0')}-${String(viernesSanto.getDate()).padStart(2, '0')}`] = 'Viernes Santo';
            
            return holidays;
        }

        function getItalyHolidays(year) {
            const easter = getEasterDate(year);
            const holidays = {};
            
            // Festivos fijos Italia
            holidays[`${year}-01-01`] = 'Capodanno';
            holidays[`${year}-01-06`] = 'Epifania';
            holidays[`${year}-04-25`] = 'Festa della Liberazione';
            holidays[`${year}-05-01`] = 'Festa del Lavoro';
            holidays[`${year}-06-02`] = 'Festa della Repubblica';
            holidays[`${year}-08-15`] = 'Assunzione di Maria';
            holidays[`${year}-11-01`] = 'Tutti i Santi';
            holidays[`${year}-12-08`] = 'Immacolata Concezione';
            holidays[`${year}-12-25`] = 'Natale';
            holidays[`${year}-12-26`] = 'Santo Stefano';
            
            // Lunes de Pascua
            const lunesPascua = new Date(easter);
            lunesPascua.setDate(easter.getDate() + 1);
            holidays[`${year}-${String(lunesPascua.getMonth() + 1).padStart(2, '0')}-${String(lunesPascua.getDate()).padStart(2, '0')}`] = 'Luned√¨ dell\'Angelo';
            
            return holidays;
        }

        function getHolidayForDay(year, month, day) {
            const key = getDayKey(year, month, day);
            const spainHolidays = getSpainHolidays(year);
            const italyHolidays = getItalyHolidays(year);
            
            const isSpain = !!spainHolidays[key];
            const isItaly = !!italyHolidays[key];
            
            if (isSpain && isItaly) {
                return 'Festivo ES/IT';
            } else if (isSpain) {
                return 'Festivo ES';
            } else if (isItaly) {
                return 'Festivo IT';
            }
            
            return null;
        }

        // ===============================
        // FLUJO DE AUTENTICACI√ìN
        // ===============================
        // 1. Usuario hace clic en "Conectar con Google" ‚Üí signIn()
        // 2. Se abre popup de Google ‚Üí tokenClient.requestAccessToken()
        // 3. Usuario autoriza ‚Üí handleAuthResponse() recibe el token
        // 4. handleAuthResponse() OCULTA loginOverlay y MUESTRA mainApp
        // 5. handleAuthResponse() llama a loadDataFromSheets()
        // 6. Si hay error 401, vuelve a mostrar loginOverlay

        function signIn() {
            console.log('üîê Solicitando autenticaci√≥n a Google...');
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                console.error('‚ùå tokenClient no est√° inicializado');
                alert('El sistema de Google a√∫n se est√° cargando. Por favor, espera 2 segundos e intenta de nuevo.');
                // Intentar inicializar de nuevo
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.accounts) {
                        initGoogleAuth();
                    }
                }, 2000);
            }
        }

        async function handleAuthResponse(response) {
            if (response.error) {
                console.error('‚ùå Error en autenticaci√≥n:', response);
                updateSyncStatus('error', 'Error al conectar');
                return;
            }

            console.log('‚úÖ Token recibido');
            accessToken = response.access_token;
            
            // Ocultar login y mostrar app
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Mostrar estado de carga
            updateSyncStatus('syncing', 'üì• Cargando datos...');
            
            try {
                // ESPERAR a que carguen los datos ANTES de renderizar
                await loadDataFromSheets();
                
                console.log('üìä Datos cargados, procediendo a renderizar...');
                console.log('üìä Total items en Ricardo:', Object.keys(data.Ricardo).length);
                console.log('üìä Total items en Sylvia:', Object.keys(data.Sylvia).length);
                
                dataLoaded = true;
                renderCalendar();
                updateSummary();
                updateSyncStatus('synced', 'Sincronizado');
                
                // Sync autom√°tico cada 60 seg
                setInterval(syncData, 60000);
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                updateSyncStatus('error', 'Error de conexi√≥n');
                dataLoaded = false;
            }
            
            // Sincronizar Calendar (no cr√≠tico)
            syncCalendarEvents().catch(err => {
                console.error('‚ö†Ô∏è Error en Calendar:', err);
            });
        }

        // ===============================
        // PROTECCI√ìN ANTI-SOBRESCRITURA
        // ===============================
        
        async function readServerTimestamp() {
            if (!accessToken) return 0;
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!Z1`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                // Detectar error 401
                if (response.status === 401) {
                    console.error('‚ùå Token inv√°lido al leer timestamp (401)');
                    throw new Error('401 Unauthorized');
                }

                if (!response.ok) {
                    console.warn('‚ö†Ô∏è No se pudo leer timestamp de Z1');
                    return 0;
                }

                const result = await response.json();
                const timestamp = result.values && result.values[0] && result.values[0][0];
                const ts = parseInt(timestamp) || 0;
                console.log(`üì• Timestamp del servidor: ${ts > 0 ? new Date(ts).toLocaleString('es-ES') : 'Sin timestamp'}`);
                return ts;
            } catch (error) {
                // Re-lanzar errores 401 para que los capture el caller
                if (error.message.includes('401')) {
                    throw error;
                }
                console.error('‚ùå Error al leer timestamp:', error);
                return 0;
            }
        }

        async function updateServerTimestamp() {
            if (!accessToken) return false;
            
            const newTimestamp = Date.now();
            
            try {
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!Z1?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: [[newTimestamp]]
                        })
                    }
                );
                
                lastServerTimestamp = newTimestamp;
                console.log(`‚è∞ Timestamp actualizado en Z1: ${new Date(newTimestamp).toLocaleString('es-ES')}`);
                return true;
            } catch (error) {
                console.error('‚ùå Error al actualizar timestamp:', error);
                return false;
            }
        }

async function loadDataFromSheets() {
            if (!accessToken) {
                console.error('‚ùå No hay token');
                throw new Error('No access token');
            }
            
            console.log('üì• Cargando datos...');
            updateSyncStatus('syncing', 'Cargando...');
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A2:E`,
                    {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }
                );

                if (response.status === 401) {
                    throw new Error('Token expirado');
                }

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                const result = await response.json();
                data = { Ricardo: {}, Sylvia: {} };
                
                if (result.values && result.values.length > 0) {
                    console.log(`üìä ${result.values.length} registros`);
                    
                    result.values.forEach(row => {
                        let [date, location, note, profile, timestamp] = row;
                        if (date && profile) {
                            let cleanDate = date.trim();
                            let cleanProfile = profile.trim();
                            
                            // Normalizar fecha
                            if (cleanDate.includes('/')) {
                                const parts = cleanDate.split('/');
                                if (parts.length === 3) {
                                    const year = parts[2].length === 2 ? "20" + parts[2] : parts[2];
                                    cleanDate = `${year}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                }
                            }
                            
                            const p = cleanProfile.charAt(0).toUpperCase() + cleanProfile.slice(1).toLowerCase();
                            let cleanLocation = null;
                            if (location && location.trim()) {
                                cleanLocation = location.trim().toUpperCase();
                            }
                            
                            const ts = timestamp ? parseInt(timestamp) : Date.now();
                            
                            if (data[p]) {
                                data[p][cleanDate] = {
                                    location: cleanLocation,
                                    note: note ? note.trim() : '',
                                    timestamp: ts
                                };
                                console.log(`üíæ Guardando: [${p}][${cleanDate}] = ${cleanLocation}`);
                            }
                        }
                    });
                    
                    console.log('‚úÖ Datos cargados');
                } else {
                    console.log('‚ÑπÔ∏è Sheet vac√≠o');
                }
                
                // Guardar en localStorage
                localStorage.setItem('residenceData', JSON.stringify(data));
                
                updateSyncStatus('synced', 'Sincronizado');
            } catch (error) {
                console.error('‚ùå Error:', error);
                throw error;
            }
        }

        async function syncCalendarEvents() {
            if (!accessToken) {
                console.log('‚ö†Ô∏è No hay accessToken - necesitas autenticarte');
                return;
            }
            
            try {
                console.log('üîÑ Sincronizando eventos del calendario...');
                
                // Obtener eventos del a√±o actual
                const timeMin = new Date(currentYear, 0, 1).toISOString();
                const timeMax = new Date(currentYear, 11, 31, 23, 59, 59).toISOString();
                
                console.log(`üîç Buscando eventos entre ${timeMin} y ${timeMax}`);
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true`,
                    {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}` 
                        }
                    }
                );

                console.log(`üì° Respuesta del servidor: ${response.status} ${response.statusText}`);

                // Manejo de error 401 - Token expirado
                if (response.status === 401) {
                    console.warn('üîê Token expirado (401). Solicitando renovaci√≥n...');
                    try {
                        tokenClient.requestAccessToken();
                        console.log('‚úÖ Pop-up de autenticaci√≥n lanzado.');
                        return;
                    } catch (authError) {
                        console.error('‚ùå Error al renovar autenticaci√≥n:', authError);
                        alert('Tu sesi√≥n ha expirado. Por favor, vuelve a conectar con Google.');
                        return;
                    }
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error al obtener eventos:', response.status, errorText);
                    return;
                }

                const result = await response.json();
                
                if (!result.items || result.items.length === 0) {
                    console.log('‚ÑπÔ∏è No hay eventos en el calendario para este a√±o');
                    return;
                }
                
                console.log(`üìÖ ${result.items.length} eventos encontrados en el calendario`);
                
                let eventsImported = 0;
                
                result.items.forEach(event => {
                    const summary = (event.summary || '').trim();
                    const summaryLower = summary.toLowerCase();
                    const description = (event.description || '').toLowerCase();
                    const location = (event.location || '').toLowerCase();
                    
                    // Buscar en t√≠tulo, descripci√≥n y ubicaci√≥n
                    const combinedText = `${summaryLower} ${description} ${location}`;
                    
                    // Comprobamos si alguna keyword est√° en el evento
                    const hasKeyword = CALENDAR_KEYWORDS.some(kw => 
                        combinedText.includes(kw.toLowerCase().trim())
                    );
                    
                    if (hasKeyword && event.start) {
                        let eventDate = event.start.date || event.start.dateTime.split('T')[0];
                        
                        // 1. Asegurar que el perfil y la fecha existen
                        if (!data[currentProfile]) data[currentProfile] = {};
                        
                        // 2. Obtener datos existentes del d√≠a (para preservar la ubicaci√≥n)
                        const existingDay = data[currentProfile][eventDate] || { location: null, note: '' };
                        
                        const currentNote = existingDay.note || '';
                        const currentNoteLower = currentNote.toLowerCase();
                        const summaryLower = summary.toLowerCase();
                        
                        // 3. Comprobar duplicados e importar
                        if (!currentNoteLower.includes(summaryLower)) {
                            // CR√çTICO: Preservar la ubicaci√≥n existente del Excel
                            data[currentProfile][eventDate] = {
                                location: existingDay.location || null, // Mantener la ubicaci√≥n del Excel
                                note: (currentNote ? currentNote + '\n' + summary : summary).trim()
                            };
                            eventsImported++;
                            const locInfo = existingDay.location ? `(ubicaci√≥n: ${existingDay.location})` : '(sin ubicaci√≥n)';
                            console.log(`‚úÖ ¬°IMPORTADO!: "${summary}" en ${eventDate} ${locInfo}`);
                        }
                    }
                });
                
                if (eventsImported > 0) {
                    console.log(`üìä Total eventos importados: ${eventsImported}`);
                    lastCalendarSync = new Date();
                    renderCalendar();
                    updateSummary();
                    // IMPORTANTE: Guardar en Sheets tras importar
                    await saveDataToSheets();
                } else {
                    console.log('‚ÑπÔ∏è No se encontraron eventos nuevos con las palabras clave configuradas');
                }
                
            } catch (e) {
                console.error("‚ùå Error t√©cnico en Calendar:", e);
            }
        }

        // DEBOUNCE: Esperar 10 segundos sin cambios antes de guardar
        function scheduleAutoSave() {
            pendingChanges = true;
            updateSyncStatus('syncing', 'üíæ Guardando en 10s...');
            
            // Cancelar el timer anterior si existe
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            
            // Programar guardado en 10 segundos
            saveTimer = setTimeout(async () => {
                if (pendingChanges) {
                    await saveDataToSheets();
                    pendingChanges = false;
                }
            }, 10000);
        }

        async function saveDataToSheets() {
            if (!accessToken) return;
            
            updateSyncStatus('syncing', 'Guardando...');
            
            try {
                const rows = [];
                const now = Date.now();
                
                Object.keys(data).forEach(profile => {
                    Object.keys(data[profile]).forEach(date => {
                        const dayData = data[profile][date];
                        rows.push([
                            date,
                            dayData.location || '',
                            dayData.note || '',
                            profile,
                            dayData.timestamp || now
                        ]);
                    });
                });

                if (rows.length === 0) {
                    console.warn('‚ö†Ô∏è Datos vac√≠os - no guardando');
                    return;
                }
                
                console.log(`üíæ Guardando ${rows.length} registros...`);
                
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A2:E?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values: rows })
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }
                
                console.log('‚úÖ Guardado OK');
                updateSyncStatus('synced', 'Guardado');
            } catch (error) {
                console.error('‚ùå Error:', error);
                updateSyncStatus('error', 'Error al guardar');
            }
        }

        async function syncData() {
            if (!accessToken) return;
            
            console.log('üîÑ Iniciando sync autom√°tico...');
            
            try {
                // 0. RESTAURAR de localStorage si hay cambios sin guardar
                const localBackup = localStorage.getItem('residenceData');
                if (localBackup) {
                    const localData = JSON.parse(localBackup);
                    // Fusionar con data actual, respetando timestamps
                    Object.keys(localData).forEach(profile => {
                        Object.keys(localData[profile]).forEach(date => {
                            const localTimestamp = localData[profile][date]?.timestamp || 0;
                            const currentTimestamp = data[profile]?.[date]?.timestamp || 0;
                            if (localTimestamp > currentTimestamp) {
                                if (!data[profile]) data[profile] = {};
                                data[profile][date] = localData[profile][date];
                            }
                        });
                    });
                }
                
                // 1. PRIMERO: Guardar cambios locales pendientes (si hay)
                if (pendingChanges) {
                    console.log('üíæ Guardando cambios locales antes de sincronizar...');
                    await saveDataToSheets();
                    pendingChanges = false;
                }
                
                // 2. DESPU√âS: Cargar cambios del servidor
                console.log('üì• Descargando datos del servidor...');
                await loadDataFromSheets();
                
                // 3. Guardar en localStorage actualizado
                localStorage.setItem('residenceData', JSON.stringify(data));
                
                // 3. Renderizar
                renderCalendar();
                updateSummary();
                
                updateSyncStatus('synced', 'Sincronizado');
            } catch (error) {
                console.error('‚ùå Error en sincronizaci√≥n:', error);
                updateSyncStatus('error', 'Error de sync');
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            const timestamp = document.getElementById('syncTimestamp');
            
            indicator.className = 'sync-indicator';
            
            if (status === 'syncing') {
                indicator.classList.add('syncing');
            } else if (status === 'error') {
                indicator.classList.add('error');
            } else if (status === 'synced') {
                const now = new Date();
                const time = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                timestamp.textContent = `√öltima sincronizaci√≥n: ${time}`;
            }
            
            statusText.textContent = text;
        }

        async function manualSync() {
            console.log('üîÑ Sincronizaci√≥n manual iniciada...');
            await syncCalendarEvents();
            await saveDataToSheets();
        }

        function switchProfile(profile) {
            currentProfile = profile;
            document.querySelectorAll('.profile-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCalendar();
            updateSummary();
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('yearDisplay').textContent = currentYear;
            renderCalendar();
            updateSummary();
        }

        function selectLocation(location) {
            selectedLocation = location;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.legend-item').classList.add('selected');
        }

        function getDayKey(year, month, day) {
            const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            // Log solo para diciembre 24-31
            if (month === 11 && day >= 24) {
                console.log(`üîë getDayKey(${year}, ${month}, ${day}) = "${key}"`);
            }
            return key;
        }

        function getDayData(year, month, day) {
            const key = getDayKey(year, month, day);
            
            // Si no existe, crear objeto vac√≠o
            if (!data[currentProfile]) {
                data[currentProfile] = {};
            }
            
            if (!data[currentProfile][key]) {
                data[currentProfile][key] = { location: null, note: '', timestamp: Date.now() };
            }
            
            // Log solo para d√≠as con datos
            if (data[currentProfile][key].location) {
                console.log(`‚úÖ ${key}: ${data[currentProfile][key].location}`);
            }
            
            return data[currentProfile][key];
        }

        function renderCalendar() {
            console.log('üé® renderCalendar() iniciado');
            console.log(`üìä Perfil actual: ${currentProfile}`);
            
            // VERIFICACI√ìN CR√çTICA: Asegurar que el perfil existe
            if (!data[currentProfile]) {
                console.warn(`‚ö†Ô∏è El perfil ${currentProfile} no existe en data. Cre√°ndolo...`);
                data[currentProfile] = {};
            }
            
            console.log(`üìä Fechas disponibles:`, Object.keys(data[currentProfile]).length);
            console.log(`üìä Primeras 5 fechas:`, Object.keys(data[currentProfile]).slice(0, 5));
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = MONTHS[month];
                monthDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                DAYS.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });

                const firstDay = new Date(currentYear, month, 1).getDay();
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                const startDay = firstDay === 0 ? 6 : firstDay - 1;

                for (let i = 0; i < startDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell empty';
                    grid.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    const dayData = getDayData(currentYear, month, day);
                    
                    // DEBUG: Ver si tiene ubicaci√≥n
                    if (month === 11 && day >= 24) { // Diciembre 24-31
                        console.log(`üîç DIC ${day}: location="${dayData.location}"`);
                    }
                    
                    if (dayData.location) {
                        dayCell.classList.add(`color-${dayData.location}`);
                        console.log(`üé® Aplicando color-${dayData.location} a ${month+1}/${day}`);
                    }

                    const editIcon = document.createElement('div');
                    editIcon.className = 'edit-icon';
                    editIcon.textContent = 'üìù';
                    dayCell.appendChild(editIcon);

                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);

                    // Festivo autom√°tico
                    const holiday = getHolidayForDay(currentYear, month, day);
                    if (holiday) {
                        const holidayNote = document.createElement('div');
                        holidayNote.className = 'holiday-note';
                        holidayNote.textContent = holiday;
                        dayCell.appendChild(holidayNote);
                    }

                    // Nota del usuario con estilo inline espec√≠fico y tooltip
                    if (dayData.note) {
                        const note = document.createElement('div');
                        note.className = 'day-note';
                        note.setAttribute('style', 'font-size: 0.6em; line-height: 1.1; margin-top: 2px; text-align: center; word-break: break-word; color: #333; font-weight: 700; max-height: 3em; overflow: hidden; cursor: help;');
                        
                        // Procesar marcadores de color
                        let html = dayData.note
                            .replace(/<r>(.*?)<\/r>/g, '<span style="color: rgb(224, 22, 39);">$1</span>')
                            .replace(/<b>(.*?)<\/b>/g, '<span style="color: #000;">$1</span>');
                        
                        note.innerHTML = html;
                        note.title = dayData.note.replace(/<\/?[rb]>/g, ''); // Tooltip sin tags
                        dayCell.appendChild(note);
                    }

                    dayCell.onclick = (e) => handleDayClick(currentYear, month, day, e);
                    grid.appendChild(dayCell);
                }

                monthDiv.appendChild(grid);
                calendar.appendChild(monthDiv);
            }
        }

        function handleDayClick(year, month, day, e) {
            e.stopPropagation();
            
            // BLOQUEO DE SEGURIDAD: No permitir ediciones hasta que los datos est√©n cargados
            if (!dataLoaded) {
                updateSyncStatus('syncing', '‚è≥ Esperando datos de Google...');
                return;
            }
            
            if (e.target.classList.contains('edit-icon')) {
                openNoteModal(year, month, day);
                return;
            }
            
            const dayData = getDayData(year, month, day);
            
            if (dayData.location === selectedLocation) {
                dayData.location = null;
            } else {
                dayData.location = selectedLocation;
            }
            
            // Actualizar timestamp al modificar
            dayData.timestamp = Date.now();
            
            // GUARDAR INMEDIATAMENTE en localStorage como backup
            localStorage.setItem('residenceData', JSON.stringify(data));
            console.log('üíæ Datos guardados en localStorage');
            
            scheduleAutoSave(); // Guardar√° en Sheets despu√©s de 10seg
            renderCalendar();
            updateSummary();
        }

        function openNoteModal(year, month, day) {
            if (!dataLoaded) {
                updateSyncStatus('syncing', '‚è≥ Esperando datos de Google...');
                return;
            }
            
            currentEditDay = { year, month, day };
            const dayData = getDayData(year, month, day);
            const dateStr = `${day} de ${MONTHS[month]} ${year}`;
            
            document.getElementById('modalHeader').textContent = `üìù ${dateStr}`;
            
            // Convertir tags a HTML
            let noteHtml = (dayData.note || '')
                .replace(/<r>(.*?)<\/r>/g, '<span style="color: rgb(224, 22, 39);" data-color="red">$1</span>')
                .replace(/<b>(.*?)<\/b>/g, '<span style="color: #000;" data-color="black">$1</span>');
            
            const noteInput = document.getElementById('noteInput');
            noteInput.innerHTML = noteHtml;
            
            // Mostrar modal usando clase
            document.getElementById('noteModal').classList.add('active');
            
            // Bloquear scroll
            document.body.style.overflow = 'hidden';
            
            // Focus
            setTimeout(() => noteInput.focus(), 100);
        }

        function closeModal() {
            document.getElementById('noteModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentEditDay = null;
        }

        function applyFormat(color) {
            const noteInput = document.getElementById('noteInput');
            const selection = window.getSelection();
            
            if (!selection.rangeCount || selection.isCollapsed) {
                alert('Selecciona el texto que quieres colorear');
                return;
            }
            
            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            
            if (selectedText.length === 0) {
                alert('Selecciona el texto que quieres colorear');
                return;
            }
            
            // Crear span con color
            const span = document.createElement('span');
            span.style.color = color === 'red' ? 'rgb(224, 22, 39)' : '#000';
            span.setAttribute('data-color', color);
            span.textContent = selectedText;
            
            // Reemplazar selecci√≥n con span
            range.deleteContents();
            range.insertNode(span);
            
            // Limpiar selecci√≥n
            selection.removeAllRanges();
            noteInput.focus();
        }

        function saveNote() {
            if (!currentEditDay) return;
            
            try {
                const { year, month, day } = currentEditDay;
                const noteInput = document.getElementById('noteInput');
                
                // Procesar HTML a tags
                let html = noteInput.innerHTML;
                html = html.replace(/<span[^>]*data-color="red"[^>]*>(.*?)<\/span>/gi, '<r>$1</r>');
                html = html.replace(/<span[^>]*data-color="black"[^>]*>(.*?)<\/span>/gi, '<b>$1</b>');
                html = html.replace(/<div>/gi, '').replace(/<\/div>/gi, '\n').replace(/<br\s*\/?>/gi, '\n');
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const note = tempDiv.innerText.trim(); // innerText limpia mejor
                
                const key = getDayKey(year, month, day);
                if (!data[currentProfile][key]) {
                    data[currentProfile][key] = { location: null, note: '', timestamp: Date.now() };
                }
                data[currentProfile][key].note = note;
                data[currentProfile][key].timestamp = Date.now();
                
                // Backup local
                localStorage.setItem('residenceData', JSON.stringify(data));
                
                // CERRAR Y ACTUALIZAR
                closeModal();
                renderCalendar();
                scheduleAutoSave();
                
            } catch (err) {
                console.error('Error:', err);
                closeModal();
            }
        }

        function updateSummary() {
            const monthlyBars = document.getElementById('monthlyBars');
            monthlyBars.innerHTML = '';

            const monthlyCounts = {};
            
            for (let m = 0; m < 12; m++) {
                monthlyCounts[m] = {};
                Object.keys(LOCATIONS).forEach(loc => monthlyCounts[m][loc] = 0);
            }

            Object.keys(data[currentProfile]).forEach(key => {
                if (key.startsWith(currentYear.toString())) {
                    const dayData = data[currentProfile][key];
                    if (dayData.location) {
                        const [year, month, day] = key.split('-').map(Number);
                        monthlyCounts[month - 1][dayData.location]++;
                    }
                }
            });

            // Crear barras para cada mes
            for (let m = 0; m < 12; m++) {
                const row = document.createElement('div');
                row.className = 'month-bar-row';

                // Label del mes
                const label = document.createElement('div');
                label.className = 'month-label';
                label.textContent = MONTHS[m].substring(0, 3);
                row.appendChild(label);

                // Contenedor de la barra
                const barContainer = document.createElement('div');
                barContainer.className = 'month-bar-container';

                // Calcular d√≠as del mes
                const daysInMonth = new Date(currentYear, m + 1, 0).getDate();
                const mad = monthlyCounts[m].MAD || 0;
                const and = monthlyCounts[m].AND || 0;
                const it = monthlyCounts[m].IT || 0;
                const fr = monthlyCounts[m].FR || 0;
                const other = monthlyCounts[m].OTHER || 0;
                
                const spain = mad + and;
                
                // Crear segmentos de la barra en orden: MAD, AND, IT, FR, OTHER
                const segments = [
                    { loc: 'MAD', days: mad, label: 'MD', title: `Madrid: ${mad} d√≠as` },
                    { loc: 'AND', days: and, label: 'AND', title: `Andratx: ${and} d√≠as` },
                    { loc: 'IT', days: it, label: 'IT', title: `Italia: ${it} d√≠as` },
                    { loc: 'FR', days: fr, label: 'FR', title: `Francia: ${fr} d√≠as` },
                    { loc: 'OTHER', days: other, label: 'OTH', title: `Other: ${other} d√≠as` }
                ];

                segments.forEach(seg => {
                    if (seg.days > 0) {
                        const segment = document.createElement('div');
                        segment.className = 'month-bar-segment';
                        const percentage = (seg.days / daysInMonth) * 100;
                        segment.style.width = `${percentage}%`;
                        segment.style.backgroundColor = LOCATIONS[seg.loc].color;
                        segment.title = seg.title;
                        
                        // Solo mostrar label si hay espacio suficiente
                        if (percentage > 15) {
                            segment.textContent = `${seg.label} ${seg.days}`;
                        } else if (percentage > 8) {
                            segment.textContent = seg.days;
                        }
                        
                        barContainer.appendChild(segment);
                    }
                });

                row.appendChild(barContainer);
                monthlyBars.appendChild(row);
            }

            updateMonthlyTable(monthlyCounts);
        }

        function scrollToTable() {
            const monthlyTable = document.getElementById('monthlyTable');
            if (monthlyTable) {
                monthlyTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function updateMonthlyTable(monthlyCounts) {
            const monthlyTable = document.getElementById('monthlyTable');
            
            let tableHTML = '<table class="breakdown-table"><thead><tr>';
            tableHTML += '<th>üìÖ</th>';
            tableHTML += '<th><div class="table-circle" style="background: #FFEB3B;"></div><small>MAD</small></th>';
            tableHTML += '<th><div class="table-circle" style="background: #2196F3;"></div><small>AND</small></th>';
            tableHTML += '<th><div class="table-circle" style="background: #F44336;"></div><small>IT</small></th>';
            tableHTML += '<th><div class="table-circle" style="background: #4CAF50;"></div><small>FR</small></th>';
            tableHTML += '<th><div class="table-circle" style="background: rgb(223, 179, 245);"></div><small>OTH</small></th>';
            tableHTML += '<th>üá™üá∏<small>ES</small></th>';
            tableHTML += '</tr></thead><tbody>';

            let yearTotals = { MAD: 0, AND: 0, IT: 0, FR: 0, OTHER: 0 };

            for (let m = 0; m < 12; m++) {
                const mad = monthlyCounts[m].MAD || 0;
                const and = monthlyCounts[m].AND || 0;
                const it = monthlyCounts[m].IT || 0;
                const fr = monthlyCounts[m].FR || 0;
                const other = monthlyCounts[m].OTHER || 0;
                const spain = mad + and;

                yearTotals.MAD += mad;
                yearTotals.AND += and;
                yearTotals.IT += it;
                yearTotals.FR += fr;
                yearTotals.OTHER += other;

                tableHTML += `<tr>
                    <td><strong>${MONTHS[m].substring(0, 3)}</strong></td>
                    <td>${mad}</td>
                    <td>${and}</td>
                    <td>${it}</td>
                    <td>${fr}</td>
                    <td>${other}</td>
                    <td class="total-spain"><strong>${spain}</strong></td>
                </tr>`;
            }

            const yearSpain = yearTotals.MAD + yearTotals.AND;

            tableHTML += `<tr style="background: #e9ecef; font-weight: bold;">
                <td>TOT</td>
                <td>${yearTotals.MAD}</td>
                <td>${yearTotals.AND}</td>
                <td>${yearTotals.IT}</td>
                <td>${yearTotals.FR}</td>
                <td>${yearTotals.OTHER}</td>
                <td class="total-spain"><strong>${yearSpain}</strong></td>
            </tr>`;

            tableHTML += '</tbody></table>';
            monthlyTable.innerHTML = tableHTML;
            
            document.getElementById('floatingNumber').textContent = yearSpain;
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `residencia_${currentYear}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('¬øEst√°s seguro de que quieres importar estos datos? Esto sobrescribir√° los datos actuales.')) {
                        data = importedData;
                        saveDataToSheets();
                        renderCalendar();
                        updateSummary();
                        alert('¬°Datos importados correctamente!');
                    }
                } catch (error) {
                    alert('Error al importar el archivo. Aseg√∫rate de que sea un archivo JSON v√°lido.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // initGoogleAuth se llama autom√°ticamente cuando el script de Google se carga
    </script>
    
    <script src="https://accounts.google.com/gsi/client" async defer onload="initGoogleAuth()"></script>
</body>
</html>